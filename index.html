<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºæ…§ç¾é£Ÿåœ°åœ– ğŸ¢</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body{font-family:"Microsoft JhengHei";margin:0;background:#fffaf5}
header{background:#ff7043;color:#fff;text-align:center;padding:15px;font-size:22px}
.buttons{text-align:center;margin:15px}
button{background:#ff7043;color:#fff;border:none;border-radius:10px;padding:10px 18px;margin:6px;cursor:pointer}
button.secondary{background:#607d8b}
button.logout{background:#9e9e9e}
button:hover{opacity:.9}
input{width:85%;padding:8px;border-radius:8px;border:1px solid #ccc;margin:5px 0}
#map{height:70vh}
.popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#fff;border-radius:15px;padding:20px;z-index:999;width:90%;max-width:420px;max-height:80vh;overflow:auto}
.menu-item{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:8px}
.close-btn{text-align:center;margin-top:10px}
.comment{border-bottom:1px dashed #ddd;padding:6px 0;font-size:14px}
.comment button{padding:3px 6px;font-size:12px;background:#ccc;color:#333;border-radius:6px}
.star-btn{margin:2px;padding:5px 8px}
</style>
</head>

<body>

<header>ğŸ¢ æ™ºæ…§ç¾é£Ÿåœ°åœ–</header>

<div id="userStatus" style="text-align:center;margin:8px;color:#555">ğŸ‘¤ å°šæœªç™»å…¥</div>

<div class="buttons">
<button onclick="openLogin()">ç™»å…¥</button>
<button onclick="openRegister()">è¨»å†Š</button>
<button class="logout" onclick="logout()">ç™»å‡º</button>
<button onclick="getLocation()">ğŸ“ é–‹å•Ÿå®šä½</button>
<button class="secondary" onclick="openOrders()">ğŸ“‹ æˆ‘çš„é è³¼ç´€éŒ„</button><br>
<input id="searchInput" placeholder="æœå°‹é£Ÿç‰©">
<button onclick="searchFood()">æœå°‹</button>
</div>

<div id="map"></div>

<!-- èœå–® -->
<div id="menuPopup" class="popup">
<h3 id="storeName"></h3>
<p id="storeTime"></p>

<h4>â­ åº—å®¶è©•åˆ†</h4>
<div id="ratingArea"></div>

<h4>ğŸ’¬ ç•™è¨€</h4>
<div id="commentList"></div>
<input id="commentInput" placeholder="ç•™ä¸‹ä½ çš„è©•è«–">
<button onclick="addComment()">é€å‡ºç•™è¨€</button>

<h4>ğŸ“‹ èœå–®</h4>
<ul id="menuList"></ul>

<button class="close-btn" onclick="closeMenu()">é—œé–‰</button>
</div>

<!-- é è³¼ -->
<div id="orderPopup" class="popup">
<h3 id="orderItemName"></h3>
<p>ä»½æ•¸</p>
<input type="number" id="orderQuantity" min="1" value="1">
<p>å–é¤æ™‚é–“</p>
<input type="time" id="pickupTime">
<button onclick="confirmOrder()">ç¢ºèªé è³¼</button>
<button class="close-btn" onclick="closeOrder()">å–æ¶ˆ</button>
</div>

<!-- è¨‚å–® -->
<div id="orderListPopup" class="popup">
<h3>ğŸ“‹ æˆ‘çš„é è³¼ç´€éŒ„</h3>
<div id="orderList"></div>
<button class="close-btn" onclick="closeOrders()">é—œé–‰</button>
</div>

<!-- ç™»å…¥ -->
<div id="loginPopup" class="popup">
<h3>ğŸ” ä½¿ç”¨è€…ç™»å…¥</h3>
<input id="loginUser" placeholder="å¸³è™Ÿ">
<input id="loginPass" type="password" placeholder="å¯†ç¢¼">
<button onclick="login()">ç™»å…¥</button>
<button class="close-btn" onclick="closeLogin()">é—œé–‰</button>
</div>

<!-- è¨»å†Š -->
<div id="registerPopup" class="popup">
<h3>ğŸ“ ä½¿ç”¨è€…è¨»å†Š</h3>
<input id="regUser" placeholder="å¸³è™Ÿ">
<input id="regPass" type="password" placeholder="å¯†ç¢¼">
<button onclick="register()">è¨»å†Š</button>
<button class="close-btn" onclick="closeRegister()">é—œé–‰</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let map,userMarker,userCircle,currentStall,currentOrderItem;
let orders=JSON.parse(localStorage.getItem("orders")||"[]");
let ratings=JSON.parse(localStorage.getItem("ratings")||"{}");
let comments=JSON.parse(localStorage.getItem("comments")||"{}");
let users=JSON.parse(localStorage.getItem("users")||"{}");
let currentUser=localStorage.getItem("currentUser")||null;
let stallMarkers=[];

/* ===== åˆ¤æ–·ç‡Ÿæ¥­ ===== */
function isOpen(timeStr){
const [o,c]=timeStr.split(" - ");
const now=new Date();
const n=now.getHours()*60+now.getMinutes();
let [oh,om]=o.split(":").map(Number);
let [ch,cm]=c.split(":").map(Number);
let omm=oh*60+om,cmm=ch*60+cm;
if(cmm<omm)cmm+=1440;
const t=n<omm?n+1440:n;
return t>=omm&&t<=cmm;
}

/* ===== ç™»å…¥ ===== */
function updateUserStatus(){
userStatus.innerText=currentUser?"ğŸ‘¤ ç›®å‰ç™»å…¥è€…ï¼š"+currentUser:"ğŸ‘¤ å°šæœªç™»å…¥";
}
updateUserStatus();

function openLogin(){loginPopup.style.display="block"}
function closeLogin(){loginPopup.style.display="none"}
function openRegister(){registerPopup.style.display="block"}
function closeRegister(){registerPopup.style.display="none"}

function register(){
if(!regUser.value||!regPass.value)return alert("è«‹è¼¸å…¥å¸³å¯†");
users[regUser.value]=regPass.value;
localStorage.setItem("users",JSON.stringify(users));
alert("è¨»å†ŠæˆåŠŸ");
closeRegister();
}

function login(){
if(users[loginUser.value]===loginPass.value){
currentUser=loginUser.value;
localStorage.setItem("currentUser",currentUser);
updateUserStatus();
closeLogin();
}else alert("å¸³å¯†éŒ¯èª¤");
}

function logout(){
currentUser=null;
localStorage.removeItem("currentUser");
updateUserStatus();
}

/* ===== è©•åˆ† ===== */
function avgRating(name){
const r=ratings[name]||[];
return r.length?r.reduce((a,b)=>a+b,0)/r.length:0;
}

/* ===== å®šä½ ===== */
function getLocation(){
navigator.geolocation.getCurrentPosition(p=>{
const lat=p.coords.latitude,lng=p.coords.longitude;
map=L.map("map").setView([lat,lng],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
userMarker=L.circleMarker([lat,lng],{radius:8,color:"red",fillColor:"red",fillOpacity:1}).addTo(map);
userCircle=L.circle([lat,lng],{radius:5000,color:"red",fillOpacity:0.1}).addTo(map);

window.stalls=[
{name:"é˜¿æ˜é¹½é…¥é›",lat:lat+.03,lng:lng+.02,time:"17:00 - 00:00",menu:["é¹½é…¥é›","ç”œä¸è¾£","åœ°ç“œè–¯æ¢"]},
{name:"çç å¥¶èŒ¶æ”¤",lat:lat-.04,lng:lng+.01,time:"10:00 - 22:00",menu:["çç å¥¶èŒ¶","å†¬ç“œæª¸æª¬","ç´…èŒ¶æ‹¿éµ"]},
{name:"é˜¿å©†æ»·å‘³",lat:lat+.02,lng:lng-.03,time:"16:00 - 23:00",menu:["æ»·è±†å¹²","æ»·è›‹","æ»·æµ·å¸¶"]},
{name:"å¹¸ç¦ç« é­šç‡’",lat:lat+.01,lng:lng+.04,time:"15:30 - 22:30",menu:["ç« é­šç‡’","æ˜å¤ªå­ç« é­šç‡’"]},
{name:"æ­£å®—ç‰›è‚‰éºµ",lat:lat-.02,lng:lng-.04,time:"11:00 - 20:30",menu:["ç´…ç‡’ç‰›è‚‰éºµ","æ¸…ç‡‰ç‰›è‚‰éºµ"]}
];
renderStalls(lat,lng);
});
}

/* ===== åº—å®¶é¡¯ç¤º ===== */
function renderStalls(lat,lng){
stallMarkers.forEach(s=>map.removeLayer(s.marker));
stallMarkers=[];
window.stalls.forEach(s=>{
if(map.distance([lat,lng],[s.lat,s.lng])<=5000){
const m=L.marker([s.lat,s.lng]).addTo(map)
.bindPopup(`<b>${s.name}</b><br>
â­ è©•åˆ†ï¼š${avgRating(s.name).toFixed(1)}<br>
${s.time}<br>
<button onclick="openMenu('${s.name}')">æŸ¥çœ‹èœå–®</button>`);
stallMarkers.push({name:s.name,menu:s.menu,marker:m});
}
});
}

/* ===== æœå°‹ ===== */
function searchFood(){
const k=searchInput.value.trim();
stallMarkers.forEach(s=>{
const ok=s.name.includes(k)||s.menu.some(m=>m.includes(k));
if(!k||ok)s.marker.addTo(map);
else map.removeLayer(s.marker);
});
}

/* ===== èœå–® ===== */
function openMenu(name){
currentStall=window.stalls.find(s=>s.name===name);
storeName.innerText=name;
storeTime.innerHTML="ç‡Ÿæ¥­æ™‚é–“ï¼š"+currentStall.time+"<br><b>"+(isOpen(currentStall.time)?"ğŸŸ¢ ç‡Ÿæ¥­ä¸­":"ğŸ”´ ä¼‘æ¯ä¸­")+"</b>";

const r=ratings[name]||[];
ratingArea.innerHTML=`å¹³å‡è©•åˆ†ï¼š${r.length?(r.reduce((a,b)=>a+b,0)/r.length).toFixed(1):"å°šç„¡"}<br>`+
[1,2,3,4,5].map(n=>`<button class="star-btn" onclick="addRating(${n})">â­${n}</button>`).join("");

const c=comments[name]||[];
commentList.innerHTML=c.length?c.map((t,i)=>`
<div class="comment">ğŸ’¬ ${t}
<button onclick="deleteComment(${i})">åˆªé™¤</button></div>`).join(""):"å°šç„¡ç•™è¨€";

menuList.innerHTML="";
currentStall.menu.forEach(i=>{
menuList.innerHTML+=`<li class="menu-item">${i}<button onclick="openOrder('${i}')">é è³¼</button></li>`;
});
menuPopup.style.display="block";
}

function addRating(n){
if(!ratings[currentStall.name])ratings[currentStall.name]=[];
ratings[currentStall.name].push(n);
localStorage.setItem("ratings",JSON.stringify(ratings));
openMenu(currentStall.name);
}

function addComment(){
if(!commentInput.value)return;
if(!comments[currentStall.name])comments[currentStall.name]=[];
comments[currentStall.name].push(commentInput.value);
localStorage.setItem("comments",JSON.stringify(comments));
commentInput.value="";
openMenu(currentStall.name);
}

function deleteComment(i){
comments[currentStall.name].splice(i,1);
localStorage.setItem("comments",JSON.stringify(comments));
openMenu(currentStall.name);
}

/* ===== é è³¼ ===== */
function openOrder(i){
currentOrderItem=i;
orderItemName.innerText="é è³¼ï¼š"+i;
orderPopup.style.display="block";
}
function confirmOrder(){
orders.push({store:currentStall.name,item:currentOrderItem,qty:orderQuantity.value,time:pickupTime.value});
localStorage.setItem("orders",JSON.stringify(orders));
alert("é è³¼æˆåŠŸ");
closeOrder();
}
function openOrders(){
orderList.innerHTML=orders.length?orders.map(o=>`ğŸª ${o.store}<br>ğŸ½ï¸ ${o.item} Ã—${o.qty}<br>â° ${o.time}<hr>`).join(""):"å°šç„¡ç´€éŒ„";
orderListPopup.style.display="block";
}

function closeMenu(){menuPopup.style.display="none"}
function closeOrder(){orderPopup.style.display="none"}
function closeOrders(){orderListPopup.style.display="none"}
</script>

</body>
</html>